<?php
//сбор профилей, с групп

echo '<html><head><title>2_parse_profiles</title><head><html>';

require_once 'vendor/vk/VK.php';
require_once 'vendor/vk/VKException.php';
require_once 'vendor/db.php';

$db = new \Db();

$config = array(
 'app_id' => 123,
 'api_secret' => '123',
);

// id групп
$groups = array(
 '14056067',
 '86122790',
 '11976871',
 '21629045',
 '83183289',
 '13039736',
 '88562768',
 '16103720',
 '30355567',
 '70797637',
 '2825946',
 '3941779',
 '3200578',
 '56961890',
 '77221638',
 '48225016',
 '4682656',
 '11476584',
 '550693',
 '109853460',
 '7767490',
 '45993367',
 '58435047',
 '1690689',
 '43975783',
 '26528461',
 '96977406',
 '106585766',
 '37545016',
 '1311698',
 '50678575',
 '72498210',
 '46813969',
 '86869036',
 '10161648',
 '60605395',
 '58568452',
 '16182966',
 '20506724',
 '48024734',
 '21026836',
 '90982131',
 '15983845',
 '97247292',
 '90865064',
 '46283637',
 '45999539',
 '56737088',
 '77676851',
 '35863329',
 '2364487',
 '92965958',
 '75353089',
 '86188517',
 '96211216',
 '12909571',
 '110466195',
 '969745',
 '32610717',
 '72586535',
 '10210377',
 '3165045',
 '115017699',
 '56099621',
 '17702343',
 '58485052',
 '114034260',
 '30696840',
 '103002910',
 '119050709',
 '72423064',
 '55780150',
 '104731221',
 '80693701',
 '63977066',
 '124322447',
 '81967449',
 '11050846',
 '81471663',
 '114637536',
 '51260358',
 '119051174',
 '118748491',
 '124376015',
 '16211470',
 '45954963',
 '123012809',
 '97527101',
 '30169919',
 '70369111',
 '63125114',
 '30731266',
 '105998453',
 '104473806',
 '103309909',
 '46094682',
 '124470209',
 '124040464',
 '123363457',
 '120506405',
 '116663245',
 '110420126',
 '109863027',
 '107337931',
 '84576165',
 '83856900',
 '68151125',
 '67734310',
 '36839437',
 '30148698',
 '125733969',
 '118144156',
 '115069223',
 '106700392',
 '67402755',
 '30733357',
 '99906322',
 '83421700',
 '97333114',
 '84710246',
 '58901534',
 '52319854',
 '33382403',
 '117888685',
 '96515376',
 '119770294',
 '98811350',
 '82070311',
 '72500903',
 '65099676',
 '103097254',
 '12047550',
 '106575413',
 '115719935',
 '57880788',
 '93111',
 '55615958',
 '17568160',
 '22963785',
 '64509533',
 '16040595',
 '41331816',
 '86829728',
 '55931728',
 '1011458',
 '30895474',
 '43318357',
 '65872754',
 '24208834',
 '9308995',
 '35273451',
 '85158957',
 '41432459',
 '34561744',
 '32125543',
 '107430890',
 '88811074',
 '55428515',
 '30557121',
 '9523518',
 '80164733',
 '12162312',
 '49062914',
 '88729071',
 '56417520',
 '2650394',
 '64103633',
 '92329629',
 '9798101',
 '107646817',
 '78270620',
 '116551602',
 '33899452',
 '97110369',
 '15431195',
 '24688664',
 '35694363',
 '20433391',
 '80896201',
 '36366668',
 '42525495',
 '28935489',
 '72583966',
 '71284530',
 '55134725',
 '63916684',
 '8411659',
 '12751507',
 '22871780',
 '109936395',
 '60315786',
 '9221071',
 '14307604',
 '22538945',
 '56109724',
 '18996020',
 '20450561',
 '86718532',
 '9959364',
 '78065115',
 '33853209',
 '64075774',
 '103344853',
 '45663181',
 '13864094',
 '65328109',
 '58345947',
 '77639886',
 '89223442',
 '3098227',
 '74130808',
 '104038408',
 '75255187',
 '13247213',
 '14559642',
 '50512128',
 '71102758',
 '94258931',
 '77673329',
 '108119049',
 '11886896',
 '20234885',
 '58273610',
 '66713030',
 '82774936',
 '69904520',
 '41570327',
 '16629156',
 '173612',
 '34882780',
 '89837006',
 '87041878',
 '33723051',
 '15600993',
 '17445935',
 '53600656',
 '50822747',
 '62224065',
 '56241045',
 '80457213',
 '29618567',
 '32513420',
 '67079623',
 '80456610',
 '51457055',
 '9327907',
 '83600392',
 '60077811',
 '45929269',
 '49623059',
 '46230750',
 '1120256',
 '38916241',
 '59474255',
 '57161770',
 '73137318',
 '74743195',
 '12317245',
 '26464283',
 '48649863',
 '7823638',
 '54228797',
 '33432939',
 '112012341',
 '80829742',
 '68691375',
 '65044543',
 '52166970',
 '62681426',
 '60582192',
 '56849017',
 '29650646',
 '45674198',
 '102951764',
 '68489381',
 '11859712',
 '52898868',
 '30774324',
 '4954085',
 '32538278',
 '30100720',
 '9264707',
 '46284284',
 '35494159',
 '92919023',
 '21184556',
 '18304821',
 '96871488',
 '111309042',
 '68641720',
 '20628920',
 '13920039',
 '52083624',
 '80270956',
 '31894432',
 '72457250',
 '93259767',
 '52731236',
 '61310506',
 '2165638',
 '60574106',
 '6594897',
 '59782131',
 '47479957',
 '93501273',
 '40741173',
 '13629856',
 '97263980',
 '100364970',
 '91054321',
 '30712592',
 '60815620',
 '53909608',
 '99115958',
 '22288531',
 '18983665',
 '82266193',
 '77599785',
 '64144885',
 '31973372',
 '112285769',
 '79731348',
 '72760777',
 '56388912',
 '83449673',
 '38738264',
 '94702187',
 '44078277',
 '26094733',
 '104741801',
 '68163276',
 '76639285',
 '111223680',
 '12067443',
 '66459152',
 '49536723',
 '68958646',
 '105955158',
 '109709616',
 '46380538',
 '67201148',
 '19730631',
 '64519279',
 '67329732',
 '23312216',
 '24916728',
 '109810280',
 '121575725',
 '103060178',
 '28594000',
 '89195699',
 '89289346',
 '65470632',
 '97130898',
 '76806025',
 '52384467',
 '33224565',
 '34069131',
 '89893317',
 '91371418',
 '116200194',
 '55409302',
 '32382391',
 '106671869',
 '64008217',
 '81807308',
 '100568939',
 '103455565',
 '54193534',
 '56646642',
 '70498777',
 '102254722',
 '1841051',
 '29586820',
 '66189966',
 '53583508',
 '66811882',
 '14620574',
 '122388567',
 '80708495',
 '98717344',
 '60576254',
 '86659896',
 '57673770',
 '17504033',
 '83803366',
 '9979335',
 '38486812',
 '101484033',
 '66744979',
 '96246880',
 '97249010',
 '15001325',
 '117898378',
 '116532950',
 '118505739',
 '89171207',
 '59485663',
 '45812242',
 '25158157',
 '37423922',
 '21096144',
 '56677259',
 '72566409',
 '101057268',
 '31110400',
 '67566608',
 '98202295',
 '60069807',
 '48631608',
 '50323939',
 '67386764',
 '63301833',
 '82667353',
 '79940299',
 '82246915',
 '19041525',
 '11507667',
 '115338941',
 '78275074',
 '24975844',
 '67009175',
 '94710266',
 '9150122',
 '14512303',
 '55119194',
 '86167640',
 '49620317',
 '32791131',
 '85022928',
 '74187340',
 '73891518',
 '49054500',
 '102068532',
 '78974082',
 '31876628',
 '59547381',
 '75894330',
 '45011279',
 '81675329',
 '116577910',
 '63187493',
 '51304098',
 '95420402',
 '95066396',
 '59480236',
 '100216190',
 '36741808',
 '100843446',
 '38751272',
 '51563730',
 '45899961',
 '62792997',
 '56113540',
 '111279062',
 '78984244',
 '43769603',
 '91129661',
 '103682150',
 '103551686',
 '101709487',
 '61295880',
 '100589880',
 '66156008',
 '95215789',
 '50374200',
 '74130615',
 '87946635',
 '16860591',
 '70952479',
 '28207528',
 '76815774',
 '54628613',
 '41507012',
 '75158130',
 '35523687',
 '69559793',
 '43118099',
 '27955229',
 '87753041',
 '114655759',
 '52480224',
 '31656287',
 '117483552',
 '117636166',
 '92954368',
 '98541183',
 '78709408',
 '85260908',
 '91367006',
 '67572190',
 '21388480',
 '73893006',
 '30106070',
 '91970072',
 '76673875',
 '101210188',
 '90408146',
 '61513564',
 '62716448',
 '44797355',
 '31174959',
 '95768637',
 '37708054',
 '56796939',
 '64225862',
 '36552215',
 '44454579',
 '61203792',
 '13288768',
 '103576519',
 '43067813',
 '67537907',
 '92488867',
 '63159977',
 '24633265',
 '105394816',
 '42881260',
 '117344787',
 '54814223',
 '5996373',
 '99261115',
 '15756857',
 '64988795',
 '66597565',
 '45245408',
 '62339547',
 '9216938',
 '45398822',
 '83270044',
 '58183062',
 '101203671',
 '116321915',
 '108367930',
 '71806699',
 '117522096',
 '95334827',
 '48467625',
 '24501434',
 '90901877',
 '74268185',
 '47133958',
 '59386047',
 '90321633',
 '73064677',
 '101969239',
 '97413336',
 '68731578',
 '57627709',
 '73381991',
 '66660555',
 '45270000',
 '43924538',
 '23371813',
 '113516541',
 '101279126',
 '26424265',
 '90939264',
 '81189052',
 '114742149',
 '123682717',
 '121492571',
 '81007342',
 '82401286',
 '78066488',
 '22958820',
 '62561948',
 '72512342',
 '73496446',
 '44468849',
 '73679399',
 '24239616',
 '106768053',
 '58605346',
 '32621875',
 '102977328',
 '44150036',
 '43595787',
 '68519121',
 '92904897',
 '68248834',
 '44765944',
 '40135971',
 '33168402',
 '66361581',
 '114176569',
 '75465611',
 '30380567',
 '78907775',
 '100979881',
 '118199664',
 '67595238',
 '73090655',
 '26040900',
 '105628700',
 '102015634',
 '60812909',
 '56872907',
 '65672947',
 '76632710',
 '55348014',
 '12529567',
 '85031728',
 '108355128',
 '97697334',
 '80865727',
 '104106223',
 '77395952',
 '50829561',
 '32537501',
 '15669576',
 '13481536',
 '74554548',
 '55130420',
 '120565917',
 '36100636',
 '39370341',
 '77884691',
 '112140829',
 '22191207',
 '74031754',
 '120447197',
 '102407090',
 '85037684',
 '101608764',
 '102581796',
 '117916148',
 '97988343',
 '25392635',
 '67240364',
 '117098544',
 '100802326',
 '17013135',
 '65955690',
 '32924414',
 '59792772',
 '14724785',
 '97114385',
 '58268655',
 '48619739',
 '111171153',
 '66026769',
 '79079018',
 '11555433',
 '37783259',
 '105640582',
 '74575164',
 '79255803',
 '83331768',
 '57975232',
 '48712751',
 '25012646',
 '67379451',
 '62927231',
 '23729858',
 '102932367',
 '90161982',
 '50983270',
 '29932719',
 '61241914',
 '14057625',
 '105339667',
 '99641151',
 '37708075',
 '99377595',
 '93615583',
 '68876747',
 '70598930',
 '50070108',
 '46906261',
 '125544946',
 '100722668',
 '96395241',
 '85306213',
 '81095239',
 '14736307',
 '114082498',
 '94174766',
 '85870310',
 '103521453',
 '72270849',
 '116137754',
 '102123034',
 '77618848',
 '107807244',
 '81562356',
 '74785727',
 '38061566',
 '28431546',
 '94262763',
 '75419201',
 '57262872',
 '60682443',
 '119831169',
 '102752447',
 '75232914',
 '75623800',
 '12258562',
 '113447189',
 '104158174',
 '113055931',
 '53900498',
 '51261739',
 '47934936',
 '59132543',
 '79835232',
 '64802203',
 '105703703',
 '60324137',
 '101836948',
 '76570503',
 '85887413',
 '78271453',
 '59525257',
 '76584493',
 '79081302',
 '64922000',
 '77924125',
 '119758282',
 '75624461',
 '67829044',
 '119289143',
 '92434557',
 '118483328',
 '15961876',
 '81509295',
 '63474597',
 '120829116',
 '77091633',
 '69766846',
 '39731103',
 '51255984',
 '60674168',
 '111705209',
 '74354600',
 '100575953',
 '119052875',
 '63099623',
 '70533856',
 '57696837',
 '30363590',
 '100273639',
 '108990160',
 '57582802',
 '113596534',
 '87135692',
 '103817078',
 '74769169',
 '117041614',
 '123053418',
 '113215064',
 '103888430',
 '124820200',
 '13262330',
 '86795204',
 '64009434',
 '80672981',
 '78036366',
 '36751314',
 '35949951',
 '28266978',
 '80679708',
 '65844104',
 '46387111',
 '97047396',
 '64815743',
 '85513961',
 '105777343',
 '104698944',
 '103330824',
 '61036163',
 '104511219',
 '103666374',
 '97359480',
 '85963584',
 '101626096',
 '69695310',
 '65043001',
 '58284856',
 '122523251',
 '90547129',
 '122016878',
 '112489704',
 '57438410',
 '80255845',
 '105787398',
 '99743568',
 '53564817',
 '21299356',
 '54218684',
 '23884510',
 '100972896',
 '44504158',
 '110117543',
 '102850496',
 '100364906',
 '76723210',
 '37800457',
 '36604654',
 '120603688',
 '108781071',
 '103746392',
 '102617011',
 '60565866',
 '103910382',
 '96418407',
 '79099409',
 '105802892',
 '98604299',
 '82247686',
 '90975222',
 '77000728',
 '86506183',
 '46434838',
 '40912289',
 '104579383',
 '77889092',
 '80403201',
 '77277055',
 '51899041',
 '77135142',
 '116415329',
 '112536536',
 '77243849',
 '73870608',
 '11103068',
 '75933094',
 '23650618',
 '77341054',
 '79062127',
 '122447665',
 '96333145',
 '85975403',
 '78345688',
 '76111553',
 '106165494',
 '123212339',
 '118451644',
 '105583575',
 '103583773',
 '120151363',
 '98274353',
 '79243185',
 '15698378',
 '106685623',
 '102488102',
 '34099012',
 '24578525',
 '83915862',
 '65063327',
 '84840773',
 '97711590',
 '69073118',
 '46070202',
 '75132550',
 '50690830',
 '50499263',
 '29980561',
 '75780765',
 '49327559',
 '86867059',
 '84229239',
 '83511049',
 '29236082',
 '107595322',
 '65039012',
 '76862973',
 '101848198',
 '33951402',
 '34228869',
 '107116695',
 '123557320',
 '116224920',
 '36253812',
 '22609107',
 '123828638',
 '103548635',
 '104122004',
 '75142139',
 '22211185',
 '92237712',
 '116244418',
 '86477780',
 '96057931',
 '61581837',
 '28390947',
 '107832176',
 '73950543',
 '64792290',
 '64349383',
 '49380264',
 '27610611',
 '103110926',
 '85815463',
 '101512187',
 '37914143',
 '102598444',
 '124026589',
 '87150607',
 '65144032',
 '120276021',
 '114211221',
 '108864477',
 '101302593',
 '83225130',
 '82722980',
 '13606260',
 '125016987',
 '59922435',
 '69519135',
 '124483217',
 '96432290',
 '73712721',
 '108989864',
 '91160934',
 '84927953',
 '81484390',
 '77989570',
 '86204021',
 '117507477',
 '104389885',
 '42620057',
 '112854014',
 '61379587',
 '125185141',
 '117970566',
 '109280180',
 '94637624',
 '76658931',
 '71802809',
 '60064943',
 '102223647',
 '62344955',
 '65786966',
 '80528704',
 '117849547',
 '105124026',
 '101069887',
 '81868283',
 '62765248',
 '59270490',
 '58078862',
 '91331562',
 '80854613',
 '52482612',
 '84916663',
 '13350829',
 '7801060',
 '3352780',
 '89687134',
 '80554776',
 '56881018',
 '33934308',
 '118907169',
 '113123174',
 '86609836',
 '77898083',
 '64986917',
 '102923704',
 '58879847',
 '17828403',
 '112255549',
 '106977657',
 '31128040',
 '104547741',
 '85816114',
 '66197172',
 '65718625',
 '124913722',
 '107909458',
 '103905062',
 '68007493',
 '48031964',
 '45475740',
 '39364596',
 '29934389',
 '28522151',
 '84802535',
 '105633150',
 '97692643',
 '59589133',
 '55744331',
 '95037376',
 '61436745',
 '35676032',
 '17876300',
 '32499959',
 '80201462',
 '115876717',
 '114291202',
 '106024767',
 '105526004',
 '103971082',
 '85329416',
 '78700109',
 '68150903',
 '48834326',
 '48554699',
 '46409413',
 '21149586',
 '107261833',
 '46460943',
 '108058806',
 '103334685',
 '99285658',
 '83760548',
 '122396309',
 '76430302',
 '64628670',
 '56136482',
 '115164815',
 '53001055',
 '105206379',
 '101537140',
 '79525218',
 '79460287',
 '76878253',
 '64987945',
 '56965002',
 '53136553',
 '48775727',
 '115971219',
 '101504195',
 '73385211',
 '62954239',
 '7715565',
 '59714047',
 '18315296',
 '117400550',
 '112665402',
 '104553089',
 '101457831',
 '70623856',
 '65026116',
 '6981186',
 '77038796',
 '115103998',
 '105058163',
 '45848485',
 '114477054',
 '121065136',
 '60860221',
 '26322111',
 '24136160',
 '54133034',
 '112569419',
 '64844652',
 '42094746',
 '100518433',
 '105755704',
 '83424086',
 '103295952',
 '93233584',
 '78975970',
 '78688674',
 '76837053',
 '63131536',
 '102476936',
 '57117969',
 '1392180',
 '85401987',
 '75285156',
 '76284471',
 '125262575',
 '78441191',
 '58488115',
 '57627608',
 '31495554',
 '116885505',
 '105190555',
 '42650695',
 '71423181',
 '44350267',
 '107328376',
 '104629707',
 '102270818',
 '97713277',
 '94391996',
 '90522245',
 '84451407',
 '83560983',
 '81135398',
 '80509122',
 '79071168',
 '77829372',
 '75653526',
 '64346503',
 '49379185',
 '44906334',
 '43648037',
 '31574642',
 '12051877',
 '21063709',
 '94253734',
 '77942819',
 '103927019',
 '62569288',
 '101352382',
 '119542181',
 '76640305',
 '76515866',
 '58636574',
 '25747813',
 '115578500',
 '92152301',
 '81870602',
 '77600219',
 '76603066',
 '34406159',
 '13068738',
 '12472894',
 '98842027',
 '33894420',
 '107232495',
 '120736540',
 '115560271',
 '83324239',
 '96205823',
 '112446107',
 '48330038',
 '106059743',
 '101203324',
 '77581198',
 '76373847',
 '62296156',
 '117793521',
 '111949882',
 '111653212',
 '20084137',
 '100340376',
 '125678135',
 '122843242',
 '122929567',
 '1446670',
 '23330136',
 '68362906',
 '64892996',
 '110178055',
);
$groups = array_unique($groups);

foreach ($groups as $group) {
//    echo '<a target="_blank" href="https://vk.com/club' . $group . '">https://vk.com/club' . $group . '</a><br>';
 var_dump('https://vk.com/club' . $group);
}

// id стран
$countries = array(
 1 => 'Россия',
);

// id городов
$cities = array(
 1 => 'Москва',
 24 => 'Балашиха',
 36 => 'Видное',
 53 => 'Жуковский',
 69 => 'Коломна​',
 80 => 'Люберцы',
 107 => 'Орехово-Зуево​',
 115 => 'Пущино​',
 117 => 'Раменское',
 155 => 'Химки',
 270 => 'Подольск',
 312 => 'Мытищи',
 340 => 'Серпухов​',
 352 => 'Солнечногорск​',
 397 => 'Ступино​',
 428 => 'Щербинка',
 459 => 'Реутов',
 483 => 'Красногорск',
 580 => 'Электросталь',
 591 => 'Фрязино​',
 593 => 'Воскресенск​',
 598 => 'Дедовск',
 625 => 'Дмитров​',
 709 => 'Климовск​',
 722 => 'Ногинск​',
 801 => 'Лыткарино​',
 857 => 'Долгопрудный',
 859 => 'Королёв',
 872 => 'Чехов​',
 910 => 'Егорьевск​',
 991 => 'Можайск​',
 1014 => 'Кашира​',
 1033 => 'Истра​',
 1037 => 'Голицыно​',
 1297 => 'Щёлково​',
 1311 => 'Клин​',
 1386 => 'Сергиев Посад​',
 1457 => 'Электрогорск​',
 1463 => 'Зеленоград',
 1723 => 'Наро-Фоминск​',
 2079 => 'Волоколамск​',
 3022 => 'Электроугли',
 3263 => 'Зарайск​',
 3787 => 'Котельники',
 3910 => 'Звенигород​',
 4059 => 'Руза​',
 4757 => 'Павловский ​Посад​',
 4890 => 'Одинцово',
 8162 => 'Лобня',
 20404 => 'Ивантеевка​',
 20558 => 'Дзержинский',
 21611 => 'Дубна​',
 21613 => 'Железнодорожный',
 1054308 => 'Домодедово',
);

//все найденные юзеры
$all_users = array();

//юзеры, подходящие под параметры
$target_users = array();

foreach ($groups as $group) {

 try {
  $vk = new VK\VK($config['app_id'], $config['api_secret']);

  $i = 0;
  do {
   $users = $vk->api('groups.getMembers', array(
    'group_id' => $group,
    'offset' => $i,
    'count' => 1000,
    'fields' => 'country, city, sex, bdate, last_seen'
   ));
   $i += 1000;

   foreach ($users['response']['users'] as $user) {
//$all_users[] = $user;

//бан
    if (isset($user['deactivated'])) {
     continue;
    }
//страна не та
    if (!in_array($user['country'], array_keys($countries))) {
     continue;
    }

//город не тот
    if (!in_array($user['city'], array_keys($cities))) {
     continue;
    }

//последний раз заходил не позже 2 недель назад
    if ((time() - $user['last_seen']['time']) > (60 * 60 * 24 * (7 * 2))) {
     continue;
    }

//нет возраста вообще
//                if (!isset($user['bdate'])) {
//                    continue;
//                }

//год рождения в промежутке 1980-1997
    if (isset($user['bdate'])) {
     $birth = explode('.', $user['bdate']);
     if (isset($birth[2]) and ($birth[2] < 1980 or $birth[2] > 1997)) {
      continue;
     }
    }

//1-жен, 2-муж
    if ($user['sex'] == 1) {
//$target_users[] = $user;

//вставка в файл
//                file_put_contents('girls.csv',
//                  $user['first_name'] . ' ' . $user['last_name'] . ';' .
//                  'https://vk.com/id' . $user['uid'] . ';' .
//                  "\n",
//                  FILE_USE_INCLUDE_PATH | FILE_APPEND | LOCK_EX);

//вставка в базу
     $db->profile_insert($user);
    }
   }

  } while ($users['response']['users']);

 } catch (VK\VKException $error) {
  echo $error->getMessage();
 }
}

echo '<br>' . 'всего ' . count($all_users) . '<br>';
echo 'под параметры ' . count($target_users) . '<br>';
echo 'done';